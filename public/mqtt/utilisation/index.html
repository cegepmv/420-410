<!DOCTYPE html>
<html lang="fr-ca" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/420-410/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=420-410/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.142.0">
    <meta name="generator" content="Relearn 7.3.1+80e448e5bdaa92c87ee0d0d86f1125c8606ebf5f">
    <meta name="description" content="Pour le cours, SVP utilisez l’agent MQTT disponible sur le réseau interne au nom mqttbroker.lan.
Dans ce cours nous utiliserons Mosquitto. Cette implémentation de MQTT, développée par la fondation Eclipse, fournit des utilitaires de ligne de commande pour envoyer et recevoir des messages (mosquitto_pub et mosquitto_sub), et aussi des librairies permettant d’implémenter des clients MQTT en C/C&#43;&#43;.
Agent MQTT Mosquitto Pour installer le service mosquitto, lancez la commande suivante:
apt update apt install mosquitto Configuration de base Les paramètres de configuration de mosquitto sont définis dans le fichier /etc/mosquitto/mosquitto.conf.">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Utilisation :: Introduction aux plateformes IdO">
    <meta name="twitter:description" content="Pour le cours, SVP utilisez l’agent MQTT disponible sur le réseau interne au nom mqttbroker.lan.
Dans ce cours nous utiliserons Mosquitto. Cette implémentation de MQTT, développée par la fondation Eclipse, fournit des utilitaires de ligne de commande pour envoyer et recevoir des messages (mosquitto_pub et mosquitto_sub), et aussi des librairies permettant d’implémenter des clients MQTT en C/C&#43;&#43;.
Agent MQTT Mosquitto Pour installer le service mosquitto, lancez la commande suivante:
apt update apt install mosquitto Configuration de base Les paramètres de configuration de mosquitto sont définis dans le fichier /etc/mosquitto/mosquitto.conf.">
    <meta property="og:url" content="http://localhost:1313/420-410/mqtt/utilisation/index.html">
    <meta property="og:site_name" content="Introduction aux plateformes IdO">
    <meta property="og:title" content="Utilisation :: Introduction aux plateformes IdO">
    <meta property="og:description" content="Pour le cours, SVP utilisez l’agent MQTT disponible sur le réseau interne au nom mqttbroker.lan.
Dans ce cours nous utiliserons Mosquitto. Cette implémentation de MQTT, développée par la fondation Eclipse, fournit des utilitaires de ligne de commande pour envoyer et recevoir des messages (mosquitto_pub et mosquitto_sub), et aussi des librairies permettant d’implémenter des clients MQTT en C/C&#43;&#43;.
Agent MQTT Mosquitto Pour installer le service mosquitto, lancez la commande suivante:
apt update apt install mosquitto Configuration de base Les paramètres de configuration de mosquitto sont définis dans le fichier /etc/mosquitto/mosquitto.conf.">
    <meta property="og:locale" content="fr_ca">
    <meta property="og:type" content="article">
    <meta property="article:section" content="MQTT">
    <meta property="article:published_time" content="2024-03-14T11:51:44-04:00">
    <meta property="article:modified_time" content="2024-03-14T11:51:44-04:00">
    <meta itemprop="name" content="Utilisation :: Introduction aux plateformes IdO">
    <meta itemprop="description" content="Pour le cours, SVP utilisez l’agent MQTT disponible sur le réseau interne au nom mqttbroker.lan.
Dans ce cours nous utiliserons Mosquitto. Cette implémentation de MQTT, développée par la fondation Eclipse, fournit des utilitaires de ligne de commande pour envoyer et recevoir des messages (mosquitto_pub et mosquitto_sub), et aussi des librairies permettant d’implémenter des clients MQTT en C/C&#43;&#43;.
Agent MQTT Mosquitto Pour installer le service mosquitto, lancez la commande suivante:
apt update apt install mosquitto Configuration de base Les paramètres de configuration de mosquitto sont définis dans le fichier /etc/mosquitto/mosquitto.conf.">
    <meta itemprop="datePublished" content="2024-03-14T11:51:44-04:00">
    <meta itemprop="dateModified" content="2024-03-14T11:51:44-04:00">
    <meta itemprop="wordCount" content="1299">
    <title>Utilisation :: Introduction aux plateformes IdO</title><link rel="icon" href="/420-410/images/favicon.png" type="image/png">

    <link href="/420-410/css/fontawesome-all.min.css?1737577242" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/420-410/css/fontawesome-all.min.css?1737577242" rel="stylesheet"></noscript>
    <link href="/420-410/css/auto-complete.css?1737577242" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/420-410/css/auto-complete.css?1737577242" rel="stylesheet"></noscript>
    <link href="/420-410/css/perfect-scrollbar.min.css?1737577242" rel="stylesheet">
    <link href="/420-410/css/theme.css?1737577242" rel="stylesheet">
    <link href="/420-410/css/format-html.css?1737577242" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313\/420-410';
      window.relearn.min = ``;
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      // variant stuff
      window.relearn.themevariants = [ 'green' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.localStorage.setItem(window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.localStorage.getItem(window.relearn.absBaseUri + "/variant");
        var select = document.querySelector("#R-select-variant");
        if (select) {
          select.value = variant;
        }
      }
      window.relearn.initVariant = function() {
        var variant = window.localStorage.getItem(window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.localStorage.setItem(window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>
  </head>
  <body class="mobile-support html disableInlineCopyToClipboard" data-url="/420-410/mqtt/utilisation/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">MQTT</span><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Utilisation</span><meta itemprop="position" content="2"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable mqtt" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="utilisation">Utilisation</h1>

<blockquote>
<p>Pour le cours, SVP utilisez l&rsquo;agent MQTT disponible sur le réseau interne au nom <code>mqttbroker.lan</code>.</p>
</blockquote>
<p>Dans ce cours nous utiliserons <a href="https://mosquitto.org/" rel="external" target="_blank">Mosquitto</a>. Cette implémentation de MQTT, développée par la fondation <em>Eclipse</em>, fournit des utilitaires de ligne de commande pour envoyer et recevoir des messages (<code>mosquitto_pub</code> et <code>mosquitto_sub</code>), et aussi des librairies permettant d&rsquo;implémenter des clients MQTT en C/C++.</p>
<h2 id="agent-mqtt-_mosquitto_">Agent MQTT <em>Mosquitto</em></h2>
<p>Pour installer le service <em>mosquitto</em>, lancez la commande suivante:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>apt update
apt install mosquitto</code></pre></div>
<h4 id="configuration-de-base">Configuration de base</h4>
<p>Les paramètres de configuration de <em>mosquitto</em> sont définis dans le fichier <code>/etc/mosquitto/mosquitto.conf</code>.</p>
<p>Pour utiliser mosquitto sans authentification, assurez-vous d&rsquo;avoir la valeur <strong>true</strong> pour la directive <code>allow_anonymous</code>. Aussi, vérifiez que <code>listener</code> est bien au port <strong>1883</strong> et que mosquitto écoute sur toutes les interfaces (valeur <strong>0.0.0.0</strong>). Ceci correspond aux lignes suivantes dans le fichier:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>listener 1883 0.0.0.0
allow_anonymous true</code></pre></div>
<p>Laissez les autres valeurs inchangées.</p>
<p>Lorsque vous avez modifié la configuration, lancez les commandes suivantes pour démarrer le service puis pour l&rsquo;activer au démarrage du serveur:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>systemctl start mosquitto
systemctl enable mosquitto</code></pre></div>

<details open class=" box cstyle notices primary">
  <summary class="box-label" tabindex="-1">
    Note
  </summary>
  <div class="box-content">
<p>Nous verrons dans la section <a href="/420-410/mqtt/securite/">Sécurité</a> comment activer l&rsquo;authentification et le chiffrement dans mosquitto.</p>
  </div>
</details>
<h2 id="client-mqtt-_mosquitto_">Client MQTT <em>Mosquitto</em></h2>
<p>Pour installer les logiciels et librairies pour la partie client, lancez la commande suivante:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>apt update
apt install mosquitto-clients libmosquitto-dev</code></pre></div>
<p>Pour tester l&rsquo;installation, lancez le client &ldquo;abonné&rdquo; à l&rsquo;aide de la commande suivante:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>mosquitto_sub -h mqttbroker.lan -t &#39;test&#39;</code></pre></div>
<p>(Vous pouvez choisir un autre nom de rubrique que &rsquo;test')</p>
<p>Ensuite publiez un message (à partir du même hôte ou d&rsquo;un autre hôte sur le même réseau) comme suit:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>mosquitto_pub -h mqttbroker.lan -t &#39;test&#39; -m &#39;Ceci est un test&#39;</code></pre></div>
<h2 id="subscriber-en-c">&ldquo;Subscriber&rdquo; en C</h2>
<p>mqtt_sub.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    gcc -o mqtt_sub mqtt_sub.c -lmosquitto</span></span></code></pre></div>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;mosquitto.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_BROKER_HOST &#34;mqttbroker.lan&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_PORT 1883
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_TOPIC &#34;rubrique&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_QOS 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_connect</span>(<span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>userdata, <span style="color:#66d9ef">int</span> result) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mosquitto_subscribe</span>(mosq, NULL, MQTT_TOPIC, MQTT_QOS);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur: connexion broker MQTT.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_message</span>(<span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>userdata, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> mosquitto_message <span style="color:#f92672">*</span>message) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Message: (%s) %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,message<span style="color:#f92672">-&gt;</span>topic, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)message<span style="color:#f92672">-&gt;</span>payload);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> rc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_lib_init</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mosq <span style="color:#f92672">=</span> <span style="color:#a6e22e">mosquitto_new</span>(NULL, true, NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mosq) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur: création de l&#39;instance mosquitto.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_connect_callback_set</span>(mosq, on_connect);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_message_callback_set</span>(mosq, on_message);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rc <span style="color:#f92672">=</span> <span style="color:#a6e22e">mosquitto_connect</span>(mosq, MQTT_BROKER_HOST, MQTT_PORT, <span style="color:#ae81ff">60</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">!=</span> MOSQ_ERR_SUCCESS) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Connexion impossible au broker: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">mosquitto_strerror</span>(rc));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_loop_forever</span>(mosq, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_destroy</span>(mosq);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_lib_cleanup</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<h2 id="publisher-en-c">&ldquo;Publisher&rdquo; en C</h2>
<p>mqtt_pub.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    gcc -o mqtt_pub mqtt_pub.c -lmosquitto</span></span></code></pre></div>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;mosquitto.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_BROKER_HOST &#34;mqttbroker.lan&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_PORT 1883
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_TOPIC &#34;rubrique&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_QOS 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_MESSAGE &#34;Allo le monde&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_connect</span>(<span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>userdata, <span style="color:#66d9ef">int</span> result) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur: connexion broker MQTT.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_publish</span>(<span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>userdata, <span style="color:#66d9ef">int</span> mid) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Message publié.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> rc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_lib_init</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mosq <span style="color:#f92672">=</span> <span style="color:#a6e22e">mosquitto_new</span>(NULL, true, NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mosq) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur: création de l&#39;instance mosquitto.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_connect_callback_set</span>(mosq, on_connect);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_publish_callback_set</span>(mosq, on_publish);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rc <span style="color:#f92672">=</span> <span style="color:#a6e22e">mosquitto_connect</span>(mosq, MQTT_BROKER_HOST, MQTT_PORT, <span style="color:#ae81ff">60</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">!=</span> MOSQ_ERR_SUCCESS) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Connexion impossible au broker: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">mosquitto_strerror</span>(rc));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rc <span style="color:#f92672">=</span> <span style="color:#a6e22e">mosquitto_publish</span>(mosq, NULL, MQTT_TOPIC, <span style="color:#a6e22e">strlen</span>(MQTT_MESSAGE), MQTT_MESSAGE, MQTT_QOS, false);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">!=</span> MOSQ_ERR_SUCCESS) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Failed to publish message: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">mosquitto_strerror</span>(rc));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_loop_forever</span>(mosq, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_destroy</span>(mosq);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_lib_cleanup</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<h2 id="exercice-1">Exercice 1</h2>
<p>L&rsquo;agent MQTT <em>mqttbroker.lan</em> diffuse des messages dans 2 rubriques: <code>ex1_tmp</code> et <code>ex1_hum</code>. La première donne une température en Celsius et la 2e un pourcentage d&rsquo;humidité.</p>
<p>Faites un programme qui lit les valeurs des 2 rubriques et affiche les données sur une même ligne à chaque 10 secondes, formatées comme suit:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>root@pi:~# ./ex1
T: 23C | Hum: 45%
T: 23C | Hum: 45%
T: 22C | Hum: 45%
T: 22C | Hum: 45%
T: 22C | Hum: 46%</code></pre></div>
<p>Attention, l&rsquo;agent MQTT n&rsquo;envoit pas lui-même les données aux 10 secondes&hellip;</p>

<details class=" box cstyle notices transparent expand">
  <summary class="box-label">
    <i class="expander-icon fa-fw fas fa-chevron-right"></i> 
    Solution
  </summary>
  <div class="box-content">
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Les données sont écrites dans des fichiers à mesure qu&#39;elles arrivent. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Une fonction lit le contenu de ce fichiers et l&#39;affiche à chaque 10 sec.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;mosquitto.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_BROKER_HOST &#34;mqttbroker.lan&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_PORT 1883
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_TOP_TMP &#34;ex1_tmp&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_TOP_HUM &#34;ex1_hum&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define FILE_T &#34;temp.txt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define FILE_H &#34;humi.txt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_QOS 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Écrit les données &#39;data&#39;&#39; dans le fichier &#39;filename&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_data</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> filename,<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> data) {
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>fichier;
</span></span><span style="display:flex;"><span>    fichier <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(filename, <span style="color:#e6db74">&#34;w&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fichier <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Erreur lors de l&#39;ouverture du fichier.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(fichier,data);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(fichier);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Retourne un pointeur sur la chaine de caractères après le délimiteur.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">extract_data(&#34;abcd*1234&#34;, &#39;*&#39;&#39;) retourne &#34;1234&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">extract_data</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> data, <span style="color:#66d9ef">char</span> delim) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> substr <span style="color:#f92672">=</span> <span style="color:#a6e22e">strchr</span>(data,delim);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (substr <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> substr<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Prend les données dans les deux fichiers et affiche la chaine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">chaque 10sec
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_data</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        FILE <span style="color:#f92672">*</span>fptr;
</span></span><span style="display:flex;"><span>        fptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(FILE_T, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> temp[<span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fgets</span>(temp,<span style="color:#ae81ff">3</span>,fptr);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(fptr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        fptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(FILE_H, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> humi[<span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fgets</span>(humi,<span style="color:#ae81ff">3</span>,fptr);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(fptr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stdout,<span style="color:#e6db74">&#34;T: %sC | Hum: %s\%</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,temp,humi);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fflush</span>(stdout);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_connect</span>(<span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>userdata, <span style="color:#66d9ef">int</span> result) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// S&#39;abonner à 2 rubriques
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">mosquitto_subscribe</span>(mosq, NULL, MQTT_TOP_TMP, MQTT_QOS);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mosquitto_subscribe</span>(mosq, NULL, MQTT_TOP_HUM, MQTT_QOS);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur: connexion broker MQTT.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_message</span>(<span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>userdata, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> mosquitto_message <span style="color:#f92672">*</span>message) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> data <span style="color:#f92672">=</span> <span style="color:#a6e22e">extract_data</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)message<span style="color:#f92672">-&gt;</span>payload,<span style="color:#e6db74">&#39;|&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// message-&gt;topic détermine dans quel fichier on écrit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(message<span style="color:#f92672">-&gt;</span>topic,MQTT_TOP_TMP) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write_data</span>(FILE_T,data);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write_data</span>(FILE_H,data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> rc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_lib_init</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mosq <span style="color:#f92672">=</span> <span style="color:#a6e22e">mosquitto_new</span>(NULL, true, NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mosq) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur: création de l&#39;instance mosquitto.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_connect_callback_set</span>(mosq, on_connect);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_message_callback_set</span>(mosq, on_message);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rc <span style="color:#f92672">=</span> <span style="color:#a6e22e">mosquitto_connect</span>(mosq, MQTT_BROKER_HOST, MQTT_PORT, <span style="color:#ae81ff">60</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">!=</span> MOSQ_ERR_SUCCESS) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Connexion impossible au broker: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">mosquitto_strerror</span>(rc));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Lancer print_data dans un thread 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pthread_t</span> t_mosq;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pthread_create</span>(<span style="color:#f92672">&amp;</span>t_mosq,NULL,print_data,NULL) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Erreur à la création du thread pour publication.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_loop_forever</span>(mosq, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_destroy</span>(mosq);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mosquitto_lib_cleanup</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
  </div>
</details>
<h2 id="exercice-2">Exercice 2</h2>
<p>Quels sont les sous-rubriques de <em>$SYS</em> qui permettent d&rsquo;obtenir les informations suivantes sur l&rsquo;agent :</p>
<ol>
<li>Nombre d&rsquo;octets de données reçues</li>
<li>Nombre total de clients connectés</li>
<li>Nombre de messages reçus durant les 15 dernières minutes</li>
<li>Le nombre d&rsquo;abonnements en cours</li>
</ol>
<p>Cherchez la réponse dans la documentation ( <a href="https://mosquitto.org/man/mosquitto-8.html" rel="external" target="_blank">https://mosquitto.org/man/mosquitto-8.html</a> ), puis modifiez le programme client <a href="https://github.com/cegepmv/410-code/blob/main/MQTT/mqtt_sub.c" rel="external" target="_blank">mqtt_sub.c</a> pour afficher à la console ces 4 rubriques.</p>

<details class=" box cstyle notices transparent expand">
  <summary class="box-label">
    <i class="expander-icon fa-fw fas fa-chevron-right"></i> 
    Solution
  </summary>
  <div class="box-content">
<p>Ajouter les lignes suivantes dans la fonction <code>on_connect()</code>:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_connect</span>(<span style="color:#66d9ef">struct</span> mosquitto <span style="color:#f92672">*</span>mosq, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>userdata, <span style="color:#66d9ef">int</span> result) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mosquitto_subscribe</span>(mosq, NULL, <span style="color:#e6db74">&#34;$SYS/broker/bytes/received&#34;</span>, MQTT_QOS);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mosquitto_subscribe</span>(mosq, NULL, <span style="color:#e6db74">&#34;$SYS/broker/clients/connected&#34;</span>, MQTT_QOS);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mosquitto_subscribe</span>(mosq, NULL, <span style="color:#e6db74">&#34;$SYS/broker/load/messages/received/15min&#34;</span>, MQTT_QOS);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mosquitto_subscribe</span>(mosq, NULL, <span style="color:#e6db74">&#34;$SYS/broker/subscriptions/count&#34;</span>, MQTT_QOS);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur: connexion broker MQTT.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
  </div>
</details>
<h2 id="exercice-3">Exercice 3</h2>
<p>Créez le fichier <code>/etc/mosquitto/mosquittocl.conf</code>. Celui-ci contiendra 4 paramètres de configuration pour votre client:</p>
<ul>
<li>Le nom ou l&rsquo;adresse IP de l&rsquo;agent</li>
<li>Le nom du <em>topic</em></li>
<li>Le nom d&rsquo;utilisateur</li>
<li>Le mot de passe</li>
</ul>
<p>Chaque élément devra être sur sa propre ligne, par exemple:</p>
<div class="highlight wrap-code"><pre tabindex="0"><code>192.168.0.110
appli_mqtt
bob
abc-123</code></pre></div>
<p>Modifiez le code du projet 2 pour que vos 2 programmes client utilisent les données dans ce fichier de configuration.</p>

<details class=" box cstyle notices transparent expand">
  <summary class="box-label">
    <i class="expander-icon fa-fw fas fa-chevron-right"></i> 
    Solution
  </summary>
  <div class="box-content">
<p>Ajouter une référence au fichier de configuration:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_CLIENT_CONFIG &#34;/root/410-projet2/mosquittocl.conf&#34;</span></span></span></code></pre></div>
<p>Ensuite, supprimer les variables MQTT_BROKER, MQTT_TOPIC.</p>
<p>Ajouter les globales suivantes:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> mqtt_broker;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> mqtt_topic;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> mqtt_user;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> mqtt_psw;</span></span></code></pre></div>
<p>Ajouter la fonction pour lire les variables dans le fichier:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">get_config</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> filename) {
</span></span><span style="display:flex;"><span>    FILE<span style="color:#f92672">*</span> f;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ligne <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> taille <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ssize_t</span> read;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    f <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(filename,<span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (f <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    read <span style="color:#f92672">=</span> <span style="color:#a6e22e">getline</span>(<span style="color:#f92672">&amp;</span>ligne,<span style="color:#f92672">&amp;</span>taille,f);
</span></span><span style="display:flex;"><span>    mqtt_broker <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>((<span style="color:#a6e22e">strlen</span>(ligne) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(mqtt_broker, <span style="color:#a6e22e">r_trim</span>(ligne));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    read <span style="color:#f92672">=</span> <span style="color:#a6e22e">getline</span>(<span style="color:#f92672">&amp;</span>ligne,<span style="color:#f92672">&amp;</span>taille,f);
</span></span><span style="display:flex;"><span>    mqtt_topic <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>((<span style="color:#a6e22e">strlen</span>(ligne) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(mqtt_topic, <span style="color:#a6e22e">r_trim</span>(ligne));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    read <span style="color:#f92672">=</span> <span style="color:#a6e22e">getline</span>(<span style="color:#f92672">&amp;</span>ligne,<span style="color:#f92672">&amp;</span>taille,f);
</span></span><span style="display:flex;"><span>    mqtt_user<span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>((<span style="color:#a6e22e">strlen</span>(ligne) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(mqtt_user, <span style="color:#a6e22e">r_trim</span>(ligne));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    read <span style="color:#f92672">=</span> <span style="color:#a6e22e">getline</span>(<span style="color:#f92672">&amp;</span>ligne,<span style="color:#f92672">&amp;</span>taille,f);
</span></span><span style="display:flex;"><span>    mqtt_psw <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>((<span style="color:#a6e22e">strlen</span>(ligne) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(mqtt_psw, <span style="color:#a6e22e">r_trim</span>(ligne));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(f);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Ajouter le code suivant dans main():</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">get_config</span>(MQTT_CLIENT_CONFIG) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur: Lecture du fichier de configuration.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mosquitto_username_pw_set</span>(mosq,mqtt_user,mqtt_psw);</span></span></code></pre></div>
  </div>
</details>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
<svg width="255" height="68.003" viewBox="0 0 350 68.003" xmlns="http://www.w3.org/2000/svg"><g id="svgGroup" stroke-linecap="round" fill-rule="evenodd" font-size="9pt" stroke="#ffffff" stroke-width="0.25mm" fill="#ffffff" style="stroke:#ffffff;stroke-width:0.25mm;fill:#ffffff"><path d="M 100.4 67.002 L 56.6 67.002 L 56.6 65.602 Q 65.5 58.202 72.7 52.002 A 220.885 220.885 0 0 0 79.022 46.354 Q 81.944 43.635 84.444 41.079 A 132.81 132.81 0 0 0 85.15 40.352 Q 89.831 35.492 92.564 30.912 A 35.666 35.666 0 0 0 93.2 29.802 Q 96 24.702 96 19.502 A 23.026 23.026 0 0 0 95.376 13.982 A 15.644 15.644 0 0 0 90.95 6.202 Q 85.9 1.402 77.2 1.402 A 23.25 23.25 0 0 0 70.975 2.193 A 17.307 17.307 0 0 0 63.1 6.802 A 19.378 19.378 0 0 0 58.069 16.175 A 27.398 27.398 0 0 0 57.4 21.202 L 55.9 20.602 A 27.734 27.734 0 0 1 56.698 15.069 A 21.147 21.147 0 0 1 58.85 9.702 Q 61.5 5.102 66.2 2.552 A 20.811 20.811 0 0 1 72.968 0.317 A 27.399 27.399 0 0 1 77.2 0.002 A 29.218 29.218 0 0 1 81.794 0.347 A 22.6 22.6 0 0 1 85.65 1.302 A 17.842 17.842 0 0 1 90.38 3.748 A 16.244 16.244 0 0 1 92.05 5.152 Q 94.7 7.702 96.1 11.302 A 20.224 20.224 0 0 1 97.269 15.929 A 26.583 26.583 0 0 1 97.5 19.502 A 23.288 23.288 0 0 1 94.81 30.249 A 30.041 30.041 0 0 1 92.9 33.452 Q 88.3 40.202 79.75 47.852 Q 73.872 53.111 66.41 59.481 A 1196.423 1196.423 0 0 1 59.3 65.502 L 59.3 65.602 L 60.25 65.602 L 61.2 65.602 L 62.1 65.602 L 100.4 65.602 L 100.4 67.002 Z M 35 67.002 L 33.4 67.002 L 33.4 46.502 L 0 46.502 L 0 45.102 L 32.8 1.002 L 35 1.002 L 35 45.102 L 48.9 45.102 L 48.9 46.502 L 35 46.502 L 35 67.002 Z M 244.1 67.002 L 242.5 67.002 L 242.5 46.502 L 209.1 46.502 L 209.1 45.102 L 241.9 1.002 L 244.1 1.002 L 244.1 45.102 L 258 45.102 L 258 46.502 L 244.1 46.502 L 244.1 67.002 Z M 134.1 68.002 Q 122.8 68.002 116.7 59.202 A 29.95 29.95 0 0 1 112.765 50.844 Q 111.549 46.872 111.016 42.051 A 73.401 73.401 0 0 1 110.6 34.002 Q 110.6 23.331 113.182 15.878 A 29.029 29.029 0 0 1 116.7 8.802 Q 122.8 0.002 134.1 0.002 Q 145.4 0.002 151.5 8.802 A 29.95 29.95 0 0 1 155.435 17.16 Q 156.651 21.131 157.184 25.953 A 73.401 73.401 0 0 1 157.6 34.002 Q 157.6 44.672 155.018 52.125 A 29.029 29.029 0 0 1 151.5 59.202 Q 145.4 68.002 134.1 68.002 Z M 321.4 68.002 Q 310.1 68.002 304 59.202 A 29.95 29.95 0 0 1 300.065 50.844 Q 298.849 46.872 298.316 42.051 A 73.401 73.401 0 0 1 297.9 34.002 Q 297.9 23.331 300.482 15.878 A 29.029 29.029 0 0 1 304 8.802 Q 310.1 0.002 321.4 0.002 Q 332.7 0.002 338.8 8.802 A 29.95 29.95 0 0 1 342.735 17.16 Q 343.951 21.131 344.484 25.953 A 73.401 73.401 0 0 1 344.9 34.002 Q 344.9 44.672 342.318 52.125 A 29.029 29.029 0 0 1 338.8 59.202 Q 332.7 68.002 321.4 68.002 Z M 282.7 67.002 L 281.1 67.002 L 281.1 10.202 L 281.1 7.102 L 281.1 4.002 Q 278.1 8.902 273.35 12.152 A 39.094 39.094 0 0 1 266.547 15.906 A 34.337 34.337 0 0 1 263.6 17.002 L 263.1 15.702 Q 265.8 14.702 268.45 13.302 Q 271.1 11.902 273.5 10.052 Q 275.9 8.202 277.85 5.952 Q 279.8 3.702 281.1 1.002 L 282.7 1.002 L 282.7 67.002 Z M 134.1 66.602 A 22.253 22.253 0 0 0 139.882 65.884 A 17.301 17.301 0 0 0 146.05 62.852 A 19.885 19.885 0 0 0 150.779 57.51 Q 152.334 54.995 153.45 51.802 A 41.889 41.889 0 0 0 155.193 44.802 Q 155.773 41.284 155.936 37.244 A 80.409 80.409 0 0 0 156 34.002 Q 156 23.402 153.45 16.152 Q 150.9 8.902 146.05 5.152 Q 141.2 1.402 134.1 1.402 A 21.727 21.727 0 0 0 128.093 2.198 A 17.569 17.569 0 0 0 122.2 5.152 A 20.005 20.005 0 0 0 117.32 10.657 Q 115.919 12.941 114.886 15.772 A 34.522 34.522 0 0 0 114.75 16.152 Q 112.664 22.084 112.284 30.258 A 80.802 80.802 0 0 0 112.2 34.002 A 72.19 72.19 0 0 0 112.589 41.716 Q 113.006 45.592 113.871 48.905 A 37.497 37.497 0 0 0 114.75 51.802 A 29.135 29.135 0 0 0 117.155 57.055 Q 119.252 60.596 122.2 62.852 A 18.121 18.121 0 0 0 131.112 66.419 A 23.774 23.774 0 0 0 134.1 66.602 Z M 321.4 66.602 A 22.253 22.253 0 0 0 327.182 65.884 A 17.301 17.301 0 0 0 333.35 62.852 A 19.885 19.885 0 0 0 338.079 57.51 Q 339.634 54.995 340.75 51.802 A 41.889 41.889 0 0 0 342.493 44.802 Q 343.073 41.284 343.236 37.244 A 80.409 80.409 0 0 0 343.3 34.002 Q 343.3 23.402 340.75 16.152 Q 338.2 8.902 333.35 5.152 Q 328.5 1.402 321.4 1.402 A 21.727 21.727 0 0 0 315.393 2.198 A 17.569 17.569 0 0 0 309.5 5.152 A 20.005 20.005 0 0 0 304.62 10.657 Q 303.219 12.941 302.186 15.772 A 34.522 34.522 0 0 0 302.05 16.152 Q 299.964 22.084 299.584 30.258 A 80.802 80.802 0 0 0 299.5 34.002 A 72.19 72.19 0 0 0 299.889 41.716 Q 300.306 45.592 301.171 48.905 A 37.497 37.497 0 0 0 302.05 51.802 A 29.135 29.135 0 0 0 304.455 57.055 Q 306.552 60.596 309.5 62.852 A 18.121 18.121 0 0 0 318.412 66.419 A 23.774 23.774 0 0 0 321.4 66.602 Z M 1.8 45.102 L 33.4 45.102 L 33.4 8.802 L 33.4 5.752 L 33.4 2.702 L 33.3 2.702 Q 32.3 4.202 31.15 5.702 A 110.715 110.715 0 0 0 29.509 7.895 A 96.037 96.037 0 0 0 29 8.602 L 1.8 45.102 Z M 210.9 45.102 L 242.5 45.102 L 242.5 8.802 L 242.5 5.752 L 242.5 2.702 L 242.4 2.702 Q 241.4 4.202 240.25 5.702 A 110.715 110.715 0 0 0 238.609 7.895 A 96.037 96.037 0 0 0 238.1 8.602 L 210.9 45.102 Z M 170.4 39.202 L 198.5 39.202 L 198.5 40.802 L 170.4 40.802 L 170.4 39.202 Z" vector-effect="non-scaling-stroke"/></g></svg>

        </div>
        <script>
          window.index_js_url="/420-410/searchindex.en.js?1737577242";
        </script>
        <search><form action="/420-410/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
        <script>
          var contentLangs=['fr'];
        </script>
        <script src="/420-410/js/auto-complete.js?1737577242" defer></script>
        <script src="/420-410/js/lunr/lunr.min.js?1737577242" defer></script>
        <script src="/420-410/js/lunr/lunr.stemmer.support.min.js?1737577242" defer></script>
        <script src="/420-410/js/lunr/lunr.multi.min.js?1737577242" defer></script>
        <script src="/420-410/js/lunr/lunr.fr.min.js?1737577242" defer></script>
        <script src="/420-410/js/search.js?1737577242" defer></script>
      </div>
      <div id="R-homelinks" class="default-animation">
        <hr class="padding">
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div id="R-shortcutmenu-home" class="R-sidebarmenu">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/420-410/pr%C3%A9paration/index.html"><a class="padding" href="/420-410/pr%C3%A9paration/index.html">1. Préparation</a><ul id="R-subsections-481e5bcc4180197d50b8ef2fafbb3420" class="collapsible-menu"></ul></li>
          </ul>
        </div>
    
        <div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div>
        <div id="R-menu-footer">
          <hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter">
          <div id="R-prefooter" class="footerLangSwitch footerVariantSwitch footerVisitedLinks">
            <ul>
              <li id="R-select-language-container" class="footerLangSwitch">
                <div class="padding menu-control">
                  <i class="fa-fw fas fa-language"></i>
                  <span>&nbsp;</span>
                  <div class="control-style">
                    <label class="a11y-only" for="R-select-language">Language</label>
                    <select id="R-select-language" onchange="location = this.querySelector( this.value ).dataset.url;">
                      <option id="R-select-language-en" value="#R-select-language-en" data-url="/420-410/mqtt/utilisation/index.html" lang="fr-ca" selected></option>
                    </select>
                  </div>
                  <div class="clear"></div>
                </div>
              </li>
              <li id="R-select-variant-container" class="footerVariantSwitch">
                <div class="padding menu-control">
                  <i class="fa-fw fas fa-paint-brush"></i>
                  <span>&nbsp;</span>
                  <div class="control-style">
                    <label class="a11y-only" for="R-select-variant">Theme</label>
                    <select id="R-select-variant" onchange="window.relearn.changeVariant( this.value );">
                      <option id="R-select-variant-green" value="green" selected>Green</option>
                    </select>
                  </div>
                  <div class="clear"></div>
                </div>
                <script>window.relearn.markVariant();</script>
              </li>
              <li class="footerVisitedLinks">
                <div class="padding menu-control">
                  <i class="fa-fw fas fa-history"></i>
                  <span>&nbsp;</span>
                  <div class="control-style">
                    <button onclick="clearHistory();">Clear History</button>
                  </div>
                  <div class="clear"></div>
                </div>
              </li>
            </ul>
          </div>
          <div id="R-footer" class="footerFooter showFooter"><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Licence Creative Commons"
        style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br>Creative Commons
BY-NC-SA
          </div>
        </div>
      </div>
    </aside>
    <script src="/420-410/js/clipboard.min.js?1737577242" defer></script>
    <script src="/420-410/js/perfect-scrollbar.min.js?1737577242" defer></script>
    <script src="/420-410/js/theme.js?1737577242" defer></script>
  </body>
</html>
