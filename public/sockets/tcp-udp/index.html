<!DOCTYPE html>
<html lang="fr-ca" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/420-410/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=420-410/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.142.0">
    <meta name="generator" content="Relearn 7.3.1+80e448e5bdaa92c87ee0d0d86f1125c8606ebf5f">
    <meta name="description" content="Pour établir une communication entre un Raspberry Pi et un autre hôte sur le réseau, on peut adopter l’approche client-serveur:
Le serveur est celui qui reçoit les messages Le client est celui qui envoit les messages Tout dépendant des applications, le Pi peut être n’importe lequel des deux.
Deux protocoles réseau peuvent être utilisés pour envoyer des messages entre un client et un serveur, soit TCP et UDP.
TCP: une connexion est établie entre client et serveur. Cette connexion est ensuite utilisée pour que les deux s’échangent des messages. Lorsqu’un des deux termine la connexion, celle-ci est fermée. UDP: le client envoit des messages au serveur sans établir de connexion préalable. Il n’est donc pas possible de savoir si le serveur est en ligne et prêt à recevoir les messages. Pour communiquer en utilisant TCP ou UDP, il faut utiliser les sockets.">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="TCP et UDP :: Introduction aux plateformes IdO">
    <meta name="twitter:description" content="Pour établir une communication entre un Raspberry Pi et un autre hôte sur le réseau, on peut adopter l’approche client-serveur:
Le serveur est celui qui reçoit les messages Le client est celui qui envoit les messages Tout dépendant des applications, le Pi peut être n’importe lequel des deux.
Deux protocoles réseau peuvent être utilisés pour envoyer des messages entre un client et un serveur, soit TCP et UDP.
TCP: une connexion est établie entre client et serveur. Cette connexion est ensuite utilisée pour que les deux s’échangent des messages. Lorsqu’un des deux termine la connexion, celle-ci est fermée. UDP: le client envoit des messages au serveur sans établir de connexion préalable. Il n’est donc pas possible de savoir si le serveur est en ligne et prêt à recevoir les messages. Pour communiquer en utilisant TCP ou UDP, il faut utiliser les sockets.">
    <meta property="og:url" content="http://localhost:1313/420-410/sockets/tcp-udp/index.html">
    <meta property="og:site_name" content="Introduction aux plateformes IdO">
    <meta property="og:title" content="TCP et UDP :: Introduction aux plateformes IdO">
    <meta property="og:description" content="Pour établir une communication entre un Raspberry Pi et un autre hôte sur le réseau, on peut adopter l’approche client-serveur:
Le serveur est celui qui reçoit les messages Le client est celui qui envoit les messages Tout dépendant des applications, le Pi peut être n’importe lequel des deux.
Deux protocoles réseau peuvent être utilisés pour envoyer des messages entre un client et un serveur, soit TCP et UDP.
TCP: une connexion est établie entre client et serveur. Cette connexion est ensuite utilisée pour que les deux s’échangent des messages. Lorsqu’un des deux termine la connexion, celle-ci est fermée. UDP: le client envoit des messages au serveur sans établir de connexion préalable. Il n’est donc pas possible de savoir si le serveur est en ligne et prêt à recevoir les messages. Pour communiquer en utilisant TCP ou UDP, il faut utiliser les sockets.">
    <meta property="og:locale" content="fr_ca">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Sockets">
    <meta property="article:published_time" content="2024-02-06T12:05:07-05:00">
    <meta property="article:modified_time" content="2024-02-06T12:05:07-05:00">
    <meta itemprop="name" content="TCP et UDP :: Introduction aux plateformes IdO">
    <meta itemprop="description" content="Pour établir une communication entre un Raspberry Pi et un autre hôte sur le réseau, on peut adopter l’approche client-serveur:
Le serveur est celui qui reçoit les messages Le client est celui qui envoit les messages Tout dépendant des applications, le Pi peut être n’importe lequel des deux.
Deux protocoles réseau peuvent être utilisés pour envoyer des messages entre un client et un serveur, soit TCP et UDP.
TCP: une connexion est établie entre client et serveur. Cette connexion est ensuite utilisée pour que les deux s’échangent des messages. Lorsqu’un des deux termine la connexion, celle-ci est fermée. UDP: le client envoit des messages au serveur sans établir de connexion préalable. Il n’est donc pas possible de savoir si le serveur est en ligne et prêt à recevoir les messages. Pour communiquer en utilisant TCP ou UDP, il faut utiliser les sockets.">
    <meta itemprop="datePublished" content="2024-02-06T12:05:07-05:00">
    <meta itemprop="dateModified" content="2024-02-06T12:05:07-05:00">
    <meta itemprop="wordCount" content="2295">
    <title>TCP et UDP :: Introduction aux plateformes IdO</title><link rel="icon" href="/420-410/images/favicon.png" type="image/png">

    <link href="/420-410/css/fontawesome-all.min.css?1737577242" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/420-410/css/fontawesome-all.min.css?1737577242" rel="stylesheet"></noscript>
    <link href="/420-410/css/auto-complete.css?1737577242" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/420-410/css/auto-complete.css?1737577242" rel="stylesheet"></noscript>
    <link href="/420-410/css/perfect-scrollbar.min.css?1737577242" rel="stylesheet">
    <link href="/420-410/css/theme.css?1737577242" rel="stylesheet">
    <link href="/420-410/css/format-html.css?1737577242" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313\/420-410';
      window.relearn.min = ``;
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      // variant stuff
      window.relearn.themevariants = [ 'green' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.localStorage.setItem(window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.localStorage.getItem(window.relearn.absBaseUri + "/variant");
        var select = document.querySelector("#R-select-variant");
        if (select) {
          select.value = variant;
        }
      }
      window.relearn.initVariant = function() {
        var variant = window.localStorage.getItem(window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.localStorage.setItem(window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>
  </head>
  <body class="mobile-support html disableInlineCopyToClipboard" data-url="/420-410/sockets/tcp-udp/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Sockets</span><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">TCP et UDP</span><meta itemprop="position" content="2"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable sockets" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="tcp-et-udp">TCP et UDP</h1>

<p>Pour établir une communication entre un Raspberry Pi et un autre hôte sur le réseau, on peut adopter l&rsquo;approche client-serveur:</p>
<ul>
<li>Le <em>serveur</em> est celui qui reçoit les messages</li>
<li>Le <em>client</em> est celui qui envoit les messages</li>
</ul>
<p>Tout dépendant des applications, le Pi peut être n&rsquo;importe lequel des deux.</p>
<p>Deux protocoles réseau peuvent être utilisés pour envoyer des messages entre un client et un serveur, soit <em>TCP</em> et <em>UDP</em>.</p>
<ul>
<li>TCP: une connexion est établie entre client et serveur. Cette connexion est ensuite utilisée pour que les deux s&rsquo;échangent des messages. Lorsqu&rsquo;un des deux termine la connexion, celle-ci est fermée.</li>
<li>UDP: le client envoit des messages au serveur sans établir de connexion préalable. Il n&rsquo;est donc pas possible de savoir si le serveur est en ligne et prêt à recevoir les messages.</li>
</ul>
<p>Pour communiquer en utilisant TCP ou UDP, il faut utiliser les <em>sockets</em>.</p>
<p>Un socket représente le point terminal d&rsquo;une communication entre deux hôtes sur un réseau. Il peut être la source ou la destination d&rsquo;un message. Les sockets sont définis par une adresse IP et un port et sont utilisés par les programmes pour envoyer et recevoir des messages.</p>
<h2 id="client">Client</h2>
<h4 id="udp">UDP</h4>
<p>Le programme suivant envoit un message par UDP sur un réseau. L&rsquo;adresse de destination est <code>127.0.0.1</code> et le port est <code>8888</code>:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 8888
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEST_IP &#34;127.0.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MESSAGE &#34;hello!\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in dest_addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sock <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_DGRAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser la struct de l&#39;adresse IP 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    dest_addr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    dest_addr.sin_addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(DEST_IP);
</span></span><span style="display:flex;"><span>    dest_addr.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Envoyer le message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">sendto</span>(sock, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)MESSAGE, <span style="color:#a6e22e">strlen</span>(MESSAGE), MSG_CONFIRM, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Fermer le socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">close</span>(sock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Vous pouvez tester ce programme comme suit: à partir d&rsquo;un hôte sur le même réseau que le Pi, ouvrez un port UDP en mode &ldquo;listen&rdquo; avec la commande <code>nc</code>. Cet hôte joue donc le rôle de serveur. Par exemple, pour ouvrir le port UDP 8888 la commande est la suivante :</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nc -ulp <span style="color:#ae81ff">8888</span></span></span></code></pre></div>
<blockquote>
<p>Assurez-vous que la variable <code>DEST_IP</code> du programme a bien comme valeur l&rsquo;adresse de l&rsquo;hôte où vous avez lancé la commande <code>nc</code>.</p>
</blockquote>
<h4 id="tcp">TCP</h4>
<p>Le programme suivant envoit un message par TCP sur un réseau. L&rsquo;adresse de destination est <code>127.0.0.1</code> et le port est <code>8888</code>:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 8888
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEST_IP &#34;127.0.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MESSAGE &#34;hello!\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in dest_addr;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sock <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser la struct de l&#39;adresse IP 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    dest_addr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    dest_addr.sin_addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(DEST_IP);
</span></span><span style="display:flex;"><span>    dest_addr.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer la connexion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">connect</span>(sock, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Envoyer le message et fermer la connexion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">send</span>(sock, MESSAGE, <span style="color:#a6e22e">strlen</span>(MESSAGE), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(sock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Vous pouvez tester ce programme avec la commande <code>nc</code>. À partir d&rsquo;un hôte sur le même réseau que le Pi (qui aura le rôle de serveur), ouvrez un port TCP en mode &ldquo;listen&rdquo; au port UDP 8888:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nc -lp <span style="color:#ae81ff">8888</span></span></span></code></pre></div>
<blockquote>
<p>Assurez-vous que la variable <code>DEST_IP</code> du programme a bien comme valeur l&rsquo;adresse de l&rsquo;hôte où vous avez lancé la commande <code>nc</code>; ensuite exécutez-le.</p>
</blockquote>
<h2 id="serveur">Serveur</h2>
<h4 id="udp-1">UDP</h4>
<p>Le programme suivant ouvre un socket au port UDP 8888 et affiche les messages entrants:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 8888
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BUFFER_SIZE 1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> socket_local;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in adr_local, adr_dist;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[BUFFER_SIZE];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket et initialiser l&#39;adresse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    socket_local <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_DGRAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>adr_local, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(adr_local));
</span></span><span style="display:flex;"><span>    adr_local.sin_family <span style="color:#f92672">=</span> AF_INET; 
</span></span><span style="display:flex;"><span>    adr_local.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    adr_local.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Associer le socket à l&#39;adresse de l&#39;interface
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">bind</span>(socket_local, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>adr_local, <span style="color:#66d9ef">sizeof</span>(adr_local));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Réception des messages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> len, n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        len <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(adr_dist); 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Stocker le message reçu dans n
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        n <span style="color:#f92672">=</span> <span style="color:#a6e22e">recvfrom</span>(socket_local, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)buffer, BUFFER_SIZE, MSG_WAITALL, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>adr_dist, <span style="color:#f92672">&amp;</span>len);
</span></span><span style="display:flex;"><span>        buffer[n] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Afficher
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Reçu: %s&#34;</span>, buffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fflush</span>(stdout); 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(socket_local);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Pour tester ce programme à partir d&rsquo;un autre hôte (qui agit comme client), lancez la commande <code>nc</code> (remplacez 1.2.3.4 par l&rsquo;adresse IP du serveur) et tapez le message que vous voulez envoyer:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nc -u 1.2.3.4 <span style="color:#ae81ff">8888</span>
</span></span><span style="display:flex;"><span>Bonjour!</span></span></code></pre></div>
<h4 id="tcp-1">TCP</h4>
<p>Le programme suivant ouvre un socket au port TCP 8888 et attend les connexions entrantes. Lorsque la connexion est établie il affiche les messages et termine la connexion lorsque le message reçu est vide (taille 0):</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 8888
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BUFFER_SIZE 1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> socket_local, socket_dist;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in address;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> addrlen <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(address);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[BUFFER_SIZE] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket et initialiser l&#39;adresse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    socket_local <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>address, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    address.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    address.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    address.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Associer le socket à l&#39;adresse de l&#39;interface
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">bind</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Attendre une connexion entrante
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">listen</span>(socket_local, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    socket_dist <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, (<span style="color:#66d9ef">socklen_t</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Réception des messages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> datalen;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Stocker le message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        datalen <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(socket_dist, buffer, BUFFER_SIZE);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (datalen <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Déconnexion</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> { <span style="color:#75715e">// Afficher le message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Reçu: %s&#34;</span>, buffer);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fflush</span>(stdout); 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memset</span>(buffer, <span style="color:#ae81ff">0</span>, BUFFER_SIZE); 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(socket_dist);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(socket_local);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Pour tester ce programme à partir d&rsquo;un autre hôte (qui agit comme client), lancez la commande <code>nc</code> (remplacez 1.2.3.4 par l&rsquo;adresse IP du serveur) et tapez le message que vous voulez envoyer:</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nc 1.2.3.4 <span style="color:#ae81ff">8888</span>
</span></span><span style="display:flex;"><span>Bonjour!</span></span></code></pre></div>
<h1 id="exercices">Exercices</h1>
<h2 id="udp-2">UDP</h2>
<p>Créez un <strong>serveur</strong> UDP sur votre PI qui s&rsquo;attend à recevoir l&rsquo;une des trois commande suivante: allume, ferme, exit.</p>
<ul>
<li>allume :  allume une led</li>
<li>ferme : ferme cette led</li>
<li>exit : S&rsquo;assure de fermer la led et de bien fermer le serveur.</li>
</ul>
<p>Créez ensuite le <strong>client</strong> UDP sur votre ordinateur (pas le Pi). Ce client doit pouvoir envoyer ces trois messages mentionné ci-dessus.</p>
<h2 id="tcp-2">TCP</h2>
<blockquote>
<p><a href="https://github.com/cegepmv/410-code.git" rel="external" target="_blank">Source</a></p>
</blockquote>
<ol>
<li>
<p>Faites deux programmes (<code>serveur1.c</code> et <code>client1.c</code>) ayant les mêmes fonctionnalités que celui de l&rsquo;exercice précédent, mais en utilisant une connexion TCP. Au message <em>exit</em>, la connexion TCP est fermée des deux côtés.

<details class=" box cstyle notices transparent expand">
  <summary class="box-label">
    <i class="expander-icon fa-fw fas fa-chevron-right"></i> 
    Solution
  </summary>
  <div class="box-content">
<p>client1.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 9090
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEST_IP &#34;10.10.20.245&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> <span style="color:#ae81ff">9090</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in dest_addr;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sock <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);            <span style="color:#75715e">// ** SOCK_STREAM ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser la struct de l&#39;adresse IP 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    dest_addr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    dest_addr.sin_addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(DEST_IP);
</span></span><span style="display:flex;"><span>    dest_addr.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer la connexion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">connect</span>(sock, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> message[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fgets</span>(message,<span style="color:#66d9ef">sizeof</span>(message),stdin);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(sock, message, <span style="color:#a6e22e">strlen</span>(message), <span style="color:#ae81ff">0</span>);       <span style="color:#75715e">// ** MODIFIÉ **//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(message,<span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(sock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>serveur1.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pigpio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define LED_PIN 17
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 9090
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BUFFER_SIZE 1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> socket_local, socket_desc;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in address;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> addrlen <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(address);      <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> buffer[BUFFER_SIZE] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser GPIO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">gpioInitialise</span>() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur d&#39;initialisation pigpio</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket et initialiser l&#39;adresse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    socket_local <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);         <span style="color:#75715e">// ** SOCK_STREAM ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>address, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    address.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    address.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    address.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Associer le socket à l&#39;adresse de l&#39;interface
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">bind</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Attendre une connexion entrante
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">listen</span>(socket_local, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    socket_desc <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, (<span style="color:#66d9ef">socklen_t</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Réception des messages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> datalen;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Stocker le message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        datalen <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(socket_desc, buffer, BUFFER_SIZE);       <span style="color:#75715e">// ** read ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (datalen <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&lt; %s&#34;</span>,buffer);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;allume</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;ferme</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">gpioTerminate</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            } 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memset</span>(buffer, <span style="color:#ae81ff">0</span>, BUFFER_SIZE); 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(socket_desc);              <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">close</span>(socket_local);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
  </div>
</details></p>
</li>
<li>
<p>Ajoutez le fonctionnalité suivante: le serveur répond &ldquo;OK&rdquo; au client si la commande est <em>allume</em>, <em>ferme</em> ou <em>exit</em> ou &ldquo;ERR&rdquo; autrement (<code>serveur2.c</code> et <code>client2.c</code>).

<details class=" box cstyle notices transparent expand">
  <summary class="box-label">
    <i class="expander-icon fa-fw fas fa-chevron-right"></i> 
    Solution
  </summary>
  <div class="box-content">
<p>client2.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 9090
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEST_IP &#34;10.10.20.245&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ANSWER_LEN 4                </span><span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in dest_addr;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sock <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser la struct de l&#39;adresse IP 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    dest_addr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    dest_addr.sin_addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(DEST_IP);
</span></span><span style="display:flex;"><span>    dest_addr.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer la connexion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">connect</span>(sock, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> message[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> answer[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fgets</span>(message,<span style="color:#66d9ef">sizeof</span>(message),stdin);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(sock, message, <span style="color:#a6e22e">strlen</span>(message), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(message,<span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {                                <span style="color:#75715e">// ** ELSE AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// Afficher réponse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">recv</span>(sock, answer, ANSWER_LEN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&lt; %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,answer);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(sock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>serveur2.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pigpio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define LED_PIN 17
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 9090
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BUFFER_SIZE 1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ANSWER_LEN 4                            </span><span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> socket_local, socket_desc;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in address;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> addrlen <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(address);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[BUFFER_SIZE] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> answer[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser GPIO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">gpioInitialise</span>() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur d&#39;initialisation pigpio</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket et initialiser l&#39;adresse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    socket_local <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>address, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    address.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    address.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    address.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Associer le socket à l&#39;adresse de l&#39;interface
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">bind</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Attendre une connexion entrante
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">listen</span>(socket_local, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    socket_desc <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, (<span style="color:#66d9ef">socklen_t</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Réception des messages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> datalen;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strcpy</span>(answer,<span style="color:#e6db74">&#34;OK&#34;</span>);                        <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Stocker le message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        datalen <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(socket_desc, buffer, BUFFER_SIZE);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (datalen <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&lt; %s&#34;</span>,buffer);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;allume</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;ferme</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">gpioTerminate</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {                                <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">strcpy</span>(answer,<span style="color:#e6db74">&#34;ERR&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">send</span>(socket_desc, answer, ANSWER_LEN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memset</span>(buffer, <span style="color:#ae81ff">0</span>, BUFFER_SIZE); 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(socket_desc);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(socket_local);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
  </div>
</details></p>
</li>
<li>
<p>Modifiez votre programme: lorsque le client envoit <em>exit</em>, la connexion TCP est terminée, le client se termine, mais le serveur continue à attendre d&rsquo;autres connexions TCP (<code>serveur3.c</code> et <code>client3.c</code>).

<details class=" box cstyle notices transparent expand">
  <summary class="box-label">
    <i class="expander-icon fa-fw fas fa-chevron-right"></i> 
    Solution
  </summary>
  <div class="box-content">
<p>client3.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 9090
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEST_IP &#34;10.10.20.245&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ANSWER_LEN 4                
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in dest_addr;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sock <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser la struct de l&#39;adresse IP 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    dest_addr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    dest_addr.sin_addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(DEST_IP);
</span></span><span style="display:flex;"><span>    dest_addr.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer la connexion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">connect</span>(sock, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>dest_addr, <span style="color:#66d9ef">sizeof</span>(dest_addr));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> message[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> answer[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fgets</span>(message,<span style="color:#66d9ef">sizeof</span>(message),stdin);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">send</span>(sock, message, <span style="color:#a6e22e">strlen</span>(message), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Afficher réponse                     // ** MODIFIE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">recv</span>(sock, answer, ANSWER_LEN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&lt; %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,answer);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(answer,<span style="color:#e6db74">&#34;BYE&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(sock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>serveur3.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pigpio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define LED_PIN 17
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 9090
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BUFFER_SIZE 1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ANSWER_LEN 4                            
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> socket_local, socket_desc;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in address;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> addrlen <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(address);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[BUFFER_SIZE] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> answer[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser GPIO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">gpioInitialise</span>() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur d&#39;initialisation pigpio</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket et initialiser l&#39;adresse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    socket_local <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>address, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    address.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    address.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    address.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Associer le socket à l&#39;adresse de l&#39;interface
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">bind</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {                                     <span style="color:#75715e">// ** AJOUTE WHILE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Attendre une connexion entrante
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">listen</span>(socket_local, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>        socket_desc <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, (<span style="color:#66d9ef">socklen_t</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Réception des messages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> datalen;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strcpy</span>(answer,<span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Stocker le message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            datalen <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(socket_desc, buffer, BUFFER_SIZE);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (datalen <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&lt; %s&#34;</span>,buffer);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;allume</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;ferme</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">gpioWrite</span>(LED_PIN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">strcpy</span>(answer,<span style="color:#e6db74">&#34;BYE&#34;</span>);                       <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">send</span>(socket_desc, answer, ANSWER_LEN, <span style="color:#ae81ff">0</span>);   <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">strcpy</span>(answer,<span style="color:#e6db74">&#34;ERR&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">send</span>(socket_desc, answer, ANSWER_LEN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">memset</span>(buffer, <span style="color:#ae81ff">0</span>, BUFFER_SIZE); 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(socket_desc);                     <span style="color:#75715e">// ** MODIFIÉ ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(socket_local);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gpioTerminate</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
  </div>
</details></p>
</li>
<li>
<p>Ajoutez un 2e module LED sur votre Pi. Modifiez le programme (<code>serveur4.c</code> et <code>client4.c</code>) pour que les commandes envoyées permettent de spécifier laquelle des 2 LED allumer (les messages &ldquo;led1&rdquo; et &ldquo;led2&rdquo; doivent être envoyés au serveur pour qu&rsquo;il sache quelle LED allumer ou éteindre). Les messages possibles du client sont donc: <code>led1, led2, allume, ferme, exit</code>. Les messages du serveur sont <code>OK, ERR, BYE</code>.

<details class=" box cstyle notices transparent expand">
  <summary class="box-label">
    <i class="expander-icon fa-fw fas fa-chevron-right"></i> 
    Solution
  </summary>
  <div class="box-content">
<p>client4.c</p>
<p><em>Pas de changements</em></p>
<p>serveur4.c</p>
<div class="highlight wrap-code"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pigpio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define LED_PIN 17
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT 9090
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BUFFER_SIZE 1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ANSWER_LEN 4                
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LED_1 17                    </span><span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define LED_2 24                    </span><span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> socket_local, socket_desc;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in address;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> addrlen <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(address);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[BUFFER_SIZE] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> answer[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> led_pin <span style="color:#f92672">=</span> LED_1;            <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialiser GPIO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">gpioInitialise</span>() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Erreur d&#39;initialisation pigpio</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Créer le socket et initialiser l&#39;adresse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    socket_local <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>address, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    address.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    address.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    address.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Associer le socket à l&#39;adresse de l&#39;interface
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">bind</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, <span style="color:#66d9ef">sizeof</span>(address));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Attendre une connexion entrante
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">listen</span>(socket_local, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>        socket_desc <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(socket_local, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>address, (<span style="color:#66d9ef">socklen_t</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Réception des messages
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> datalen;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strcpy</span>(answer,<span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Stocker le message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            datalen <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(socket_desc, buffer, BUFFER_SIZE);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (datalen <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&lt; %s&#34;</span>,buffer);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;allume</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">gpioWrite</span>(led_pin, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;ferme</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">gpioWrite</span>(led_pin, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">gpioWrite</span>(LED_1, <span style="color:#ae81ff">0</span>);                <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">gpioWrite</span>(LED_2, <span style="color:#ae81ff">0</span>);                <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">strcpy</span>(answer,<span style="color:#e6db74">&#34;BYE&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">send</span>(socket_desc, answer, ANSWER_LEN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;led1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){  <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    led_pin <span style="color:#f92672">=</span> LED_1;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strcmp</span>(buffer,<span style="color:#e6db74">&#34;led2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){  <span style="color:#75715e">// ** AJOUTE ** //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    led_pin <span style="color:#f92672">=</span> LED_2;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">strcpy</span>(answer,<span style="color:#e6db74">&#34;ERR&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">send</span>(socket_desc, answer, ANSWER_LEN, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">memset</span>(buffer, <span style="color:#ae81ff">0</span>, BUFFER_SIZE); 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(socket_desc);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(socket_local);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gpioTerminate</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
  </div>
</details></p>
</li>
</ol>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
<svg width="255" height="68.003" viewBox="0 0 350 68.003" xmlns="http://www.w3.org/2000/svg"><g id="svgGroup" stroke-linecap="round" fill-rule="evenodd" font-size="9pt" stroke="#ffffff" stroke-width="0.25mm" fill="#ffffff" style="stroke:#ffffff;stroke-width:0.25mm;fill:#ffffff"><path d="M 100.4 67.002 L 56.6 67.002 L 56.6 65.602 Q 65.5 58.202 72.7 52.002 A 220.885 220.885 0 0 0 79.022 46.354 Q 81.944 43.635 84.444 41.079 A 132.81 132.81 0 0 0 85.15 40.352 Q 89.831 35.492 92.564 30.912 A 35.666 35.666 0 0 0 93.2 29.802 Q 96 24.702 96 19.502 A 23.026 23.026 0 0 0 95.376 13.982 A 15.644 15.644 0 0 0 90.95 6.202 Q 85.9 1.402 77.2 1.402 A 23.25 23.25 0 0 0 70.975 2.193 A 17.307 17.307 0 0 0 63.1 6.802 A 19.378 19.378 0 0 0 58.069 16.175 A 27.398 27.398 0 0 0 57.4 21.202 L 55.9 20.602 A 27.734 27.734 0 0 1 56.698 15.069 A 21.147 21.147 0 0 1 58.85 9.702 Q 61.5 5.102 66.2 2.552 A 20.811 20.811 0 0 1 72.968 0.317 A 27.399 27.399 0 0 1 77.2 0.002 A 29.218 29.218 0 0 1 81.794 0.347 A 22.6 22.6 0 0 1 85.65 1.302 A 17.842 17.842 0 0 1 90.38 3.748 A 16.244 16.244 0 0 1 92.05 5.152 Q 94.7 7.702 96.1 11.302 A 20.224 20.224 0 0 1 97.269 15.929 A 26.583 26.583 0 0 1 97.5 19.502 A 23.288 23.288 0 0 1 94.81 30.249 A 30.041 30.041 0 0 1 92.9 33.452 Q 88.3 40.202 79.75 47.852 Q 73.872 53.111 66.41 59.481 A 1196.423 1196.423 0 0 1 59.3 65.502 L 59.3 65.602 L 60.25 65.602 L 61.2 65.602 L 62.1 65.602 L 100.4 65.602 L 100.4 67.002 Z M 35 67.002 L 33.4 67.002 L 33.4 46.502 L 0 46.502 L 0 45.102 L 32.8 1.002 L 35 1.002 L 35 45.102 L 48.9 45.102 L 48.9 46.502 L 35 46.502 L 35 67.002 Z M 244.1 67.002 L 242.5 67.002 L 242.5 46.502 L 209.1 46.502 L 209.1 45.102 L 241.9 1.002 L 244.1 1.002 L 244.1 45.102 L 258 45.102 L 258 46.502 L 244.1 46.502 L 244.1 67.002 Z M 134.1 68.002 Q 122.8 68.002 116.7 59.202 A 29.95 29.95 0 0 1 112.765 50.844 Q 111.549 46.872 111.016 42.051 A 73.401 73.401 0 0 1 110.6 34.002 Q 110.6 23.331 113.182 15.878 A 29.029 29.029 0 0 1 116.7 8.802 Q 122.8 0.002 134.1 0.002 Q 145.4 0.002 151.5 8.802 A 29.95 29.95 0 0 1 155.435 17.16 Q 156.651 21.131 157.184 25.953 A 73.401 73.401 0 0 1 157.6 34.002 Q 157.6 44.672 155.018 52.125 A 29.029 29.029 0 0 1 151.5 59.202 Q 145.4 68.002 134.1 68.002 Z M 321.4 68.002 Q 310.1 68.002 304 59.202 A 29.95 29.95 0 0 1 300.065 50.844 Q 298.849 46.872 298.316 42.051 A 73.401 73.401 0 0 1 297.9 34.002 Q 297.9 23.331 300.482 15.878 A 29.029 29.029 0 0 1 304 8.802 Q 310.1 0.002 321.4 0.002 Q 332.7 0.002 338.8 8.802 A 29.95 29.95 0 0 1 342.735 17.16 Q 343.951 21.131 344.484 25.953 A 73.401 73.401 0 0 1 344.9 34.002 Q 344.9 44.672 342.318 52.125 A 29.029 29.029 0 0 1 338.8 59.202 Q 332.7 68.002 321.4 68.002 Z M 282.7 67.002 L 281.1 67.002 L 281.1 10.202 L 281.1 7.102 L 281.1 4.002 Q 278.1 8.902 273.35 12.152 A 39.094 39.094 0 0 1 266.547 15.906 A 34.337 34.337 0 0 1 263.6 17.002 L 263.1 15.702 Q 265.8 14.702 268.45 13.302 Q 271.1 11.902 273.5 10.052 Q 275.9 8.202 277.85 5.952 Q 279.8 3.702 281.1 1.002 L 282.7 1.002 L 282.7 67.002 Z M 134.1 66.602 A 22.253 22.253 0 0 0 139.882 65.884 A 17.301 17.301 0 0 0 146.05 62.852 A 19.885 19.885 0 0 0 150.779 57.51 Q 152.334 54.995 153.45 51.802 A 41.889 41.889 0 0 0 155.193 44.802 Q 155.773 41.284 155.936 37.244 A 80.409 80.409 0 0 0 156 34.002 Q 156 23.402 153.45 16.152 Q 150.9 8.902 146.05 5.152 Q 141.2 1.402 134.1 1.402 A 21.727 21.727 0 0 0 128.093 2.198 A 17.569 17.569 0 0 0 122.2 5.152 A 20.005 20.005 0 0 0 117.32 10.657 Q 115.919 12.941 114.886 15.772 A 34.522 34.522 0 0 0 114.75 16.152 Q 112.664 22.084 112.284 30.258 A 80.802 80.802 0 0 0 112.2 34.002 A 72.19 72.19 0 0 0 112.589 41.716 Q 113.006 45.592 113.871 48.905 A 37.497 37.497 0 0 0 114.75 51.802 A 29.135 29.135 0 0 0 117.155 57.055 Q 119.252 60.596 122.2 62.852 A 18.121 18.121 0 0 0 131.112 66.419 A 23.774 23.774 0 0 0 134.1 66.602 Z M 321.4 66.602 A 22.253 22.253 0 0 0 327.182 65.884 A 17.301 17.301 0 0 0 333.35 62.852 A 19.885 19.885 0 0 0 338.079 57.51 Q 339.634 54.995 340.75 51.802 A 41.889 41.889 0 0 0 342.493 44.802 Q 343.073 41.284 343.236 37.244 A 80.409 80.409 0 0 0 343.3 34.002 Q 343.3 23.402 340.75 16.152 Q 338.2 8.902 333.35 5.152 Q 328.5 1.402 321.4 1.402 A 21.727 21.727 0 0 0 315.393 2.198 A 17.569 17.569 0 0 0 309.5 5.152 A 20.005 20.005 0 0 0 304.62 10.657 Q 303.219 12.941 302.186 15.772 A 34.522 34.522 0 0 0 302.05 16.152 Q 299.964 22.084 299.584 30.258 A 80.802 80.802 0 0 0 299.5 34.002 A 72.19 72.19 0 0 0 299.889 41.716 Q 300.306 45.592 301.171 48.905 A 37.497 37.497 0 0 0 302.05 51.802 A 29.135 29.135 0 0 0 304.455 57.055 Q 306.552 60.596 309.5 62.852 A 18.121 18.121 0 0 0 318.412 66.419 A 23.774 23.774 0 0 0 321.4 66.602 Z M 1.8 45.102 L 33.4 45.102 L 33.4 8.802 L 33.4 5.752 L 33.4 2.702 L 33.3 2.702 Q 32.3 4.202 31.15 5.702 A 110.715 110.715 0 0 0 29.509 7.895 A 96.037 96.037 0 0 0 29 8.602 L 1.8 45.102 Z M 210.9 45.102 L 242.5 45.102 L 242.5 8.802 L 242.5 5.752 L 242.5 2.702 L 242.4 2.702 Q 241.4 4.202 240.25 5.702 A 110.715 110.715 0 0 0 238.609 7.895 A 96.037 96.037 0 0 0 238.1 8.602 L 210.9 45.102 Z M 170.4 39.202 L 198.5 39.202 L 198.5 40.802 L 170.4 40.802 L 170.4 39.202 Z" vector-effect="non-scaling-stroke"/></g></svg>

        </div>
        <script>
          window.index_js_url="/420-410/searchindex.en.js?1737577242";
        </script>
        <search><form action="/420-410/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
        <script>
          var contentLangs=['fr'];
        </script>
        <script src="/420-410/js/auto-complete.js?1737577242" defer></script>
        <script src="/420-410/js/lunr/lunr.min.js?1737577242" defer></script>
        <script src="/420-410/js/lunr/lunr.stemmer.support.min.js?1737577242" defer></script>
        <script src="/420-410/js/lunr/lunr.multi.min.js?1737577242" defer></script>
        <script src="/420-410/js/lunr/lunr.fr.min.js?1737577242" defer></script>
        <script src="/420-410/js/search.js?1737577242" defer></script>
      </div>
      <div id="R-homelinks" class="default-animation">
        <hr class="padding">
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div id="R-shortcutmenu-home" class="R-sidebarmenu">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/420-410/pr%C3%A9paration/index.html"><a class="padding" href="/420-410/pr%C3%A9paration/index.html">1. Préparation</a><ul id="R-subsections-481e5bcc4180197d50b8ef2fafbb3420" class="collapsible-menu"></ul></li>
          </ul>
        </div>
    
        <div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div>
        <div id="R-menu-footer">
          <hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter">
          <div id="R-prefooter" class="footerLangSwitch footerVariantSwitch footerVisitedLinks">
            <ul>
              <li id="R-select-language-container" class="footerLangSwitch">
                <div class="padding menu-control">
                  <i class="fa-fw fas fa-language"></i>
                  <span>&nbsp;</span>
                  <div class="control-style">
                    <label class="a11y-only" for="R-select-language">Language</label>
                    <select id="R-select-language" onchange="location = this.querySelector( this.value ).dataset.url;">
                      <option id="R-select-language-en" value="#R-select-language-en" data-url="/420-410/sockets/tcp-udp/index.html" lang="fr-ca" selected></option>
                    </select>
                  </div>
                  <div class="clear"></div>
                </div>
              </li>
              <li id="R-select-variant-container" class="footerVariantSwitch">
                <div class="padding menu-control">
                  <i class="fa-fw fas fa-paint-brush"></i>
                  <span>&nbsp;</span>
                  <div class="control-style">
                    <label class="a11y-only" for="R-select-variant">Theme</label>
                    <select id="R-select-variant" onchange="window.relearn.changeVariant( this.value );">
                      <option id="R-select-variant-green" value="green" selected>Green</option>
                    </select>
                  </div>
                  <div class="clear"></div>
                </div>
                <script>window.relearn.markVariant();</script>
              </li>
              <li class="footerVisitedLinks">
                <div class="padding menu-control">
                  <i class="fa-fw fas fa-history"></i>
                  <span>&nbsp;</span>
                  <div class="control-style">
                    <button onclick="clearHistory();">Clear History</button>
                  </div>
                  <div class="clear"></div>
                </div>
              </li>
            </ul>
          </div>
          <div id="R-footer" class="footerFooter showFooter"><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Licence Creative Commons"
        style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br>Creative Commons
BY-NC-SA
          </div>
        </div>
      </div>
    </aside>
    <script src="/420-410/js/clipboard.min.js?1737577242" defer></script>
    <script src="/420-410/js/perfect-scrollbar.min.js?1737577242" defer></script>
    <script src="/420-410/js/theme.js?1737577242" defer></script>
  </body>
</html>
